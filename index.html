<!DOCTYPE html>
<html>
  <head>
  <title></title>
  
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no;" />
	<meta charset="utf-8">


	<!-- iPad/iPhone specific css below, add after your main css >
	<link rel="stylesheet" media="only screen and (max-device-width: 1024px)" href="ipad.css" type="text/css" />		
	<link rel="stylesheet" media="only screen and (max-device-width: 480px)" href="iphone.css" type="text/css" />		
	-->
	<!-- If your application is targeting iOS BEFORE 4.0 you MUST put json2.js from http://www.JSON.org/json2.js into your www directory and include it here -->
	<script type="text/javascript" charset="utf-8" src="json2.js"></script>
	<script type="text/javascript" charset="utf-8" src="phonegap-1.3.0.js"></script>
	<script type="text/javascript" charset="utf-8" src="http://openlayers.org/api/OpenLayers.js"></script>
	<!--<link rel="stylesheet" href="master.css" type="text/css"/>-->
	<link rel="stylesheet" href="jquery.mobile-1.0.min.css" type="text/css"/>
	<script type="text/javascript" charset="utf-8" src="jquery-1.7.1.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="jquery.mobile-1.0.min.js"></script>
	<script src="http://debug.phonegap.com/target/target-script-min.js#F7E93C76-C0B0-5235-BA6E-6F5155BDC524"></script>
    <script type="text/javascript">


	// If you want to prevent dragging, uncomment this section
	/*
	function preventBehavior(e) 
	{ 
      e.preventDefault(); 
    };
	document.addEventListener("touchmove", preventBehavior, false);
	*/
	
	/* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
	see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
	for more details -jm */
	/*
	function handleOpenURL(url)
	{
		// TODO: do something with the url passed in.
	}
	*/
	
	/*
	 * OpenLayers.Map
	 */
	var map;
	
	var navSymbolizer = new OpenLayers.Symbolizer.Point({
		pointRadius : 10,
		externalGraphic : "15x15_Blue_Arrow.png",
		fillOpacity: 1,
		rotation: 0
	});
	
	var navStyle = new OpenLayers.StyleMap({
		"default" : new OpenLayers.Style(null, {
			rules : [ new OpenLayers.Rule({
				symbolizer : navSymbolizer
			})]
		})
	});
	
	var navigationLayer = new OpenLayers.Layer.Vector("Navigation Layer",
	{
		styleMap: navStyle
	});
	
	OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
                defaultHandlerOptions: {
                    'single': true,
                    'double': false,
                    'pixelTolerance': 0,
                    'stopSingle': false,
                    'stopDouble': false
                },

                initialize: function(options) {
                    this.handlerOptions = OpenLayers.Util.extend(
                        {}, this.defaultHandlerOptions
                    );
                    OpenLayers.Control.prototype.initialize.apply(
                        this, arguments
                    ); 
                    this.handler = new OpenLayers.Handler.Click(
                        this, {
                            'click': this.trigger
                        }, this.handlerOptions
                    );
                }, 

                trigger: function(e) {
                    navSymbolizer.rotation += 10;
					navigationLayer.redraw();
                }

            });
			
	var WGS84 = new OpenLayers.Projection("EPSG:4326");
	var WGS84_google_mercator = new OpenLayers.Projection("EPSG:900913");
	
	function onBodyLoad()
	{		
		document.addEventListener("deviceready", onDeviceReady, false);
	}
	
	var geolocationSuccess = function(position){
		var lon = position.coords.longitude;
		var lat = position.coords.latitude;
		
		var currentPoint = new OpenLayers.Geometry.Point(lon, lat).transform(WGS84, WGS84_google_mercator);
		var currentPosition = new OpenLayers.Feature.Vector(currentPoint);
		
		navigationLayer.addFeatures([currentPosition]);
		
		map.setCenter(new OpenLayers.LonLat(position.coords.longitude, position.coords.latitude)
			.transform(WGS84, WGS84_google_mercator), 17);
	}
	
	var geolocationError = function(error){
		//error handling
	}
	
	var compassSuccess = function(heading){
		navSymbolizer.rotation = heading.magneticHeading;
		navigationLayer.redraw();
	}
	
	var compassError = function(error){
		//error handling
		if(error.code == CompassError.COMPASS_INTERNAL_ERR)
			alert("compass internal error");
		else if(error.code == CompassError.COMPASS_NOT_SUPPORTED)
			alert("compass not supported");
		
	}
	/* When this function is called, PhoneGap has been initialized and is ready to roll */
	/* If you are supporting your own protocol, the var invokeString will contain any arguments to the app launch.
	see http://iphonedevelopertips.com/cocoa/launching-your-own-application-via-a-custom-url-scheme.html
	for more details -jm */
	function onDeviceReady()
	{
		var networkState = navigator.network.connection.type;

        /*var states = {};
        states[Connection.UNKNOWN]  = 'Unknown connection';
        states[Connection.ETHERNET] = 'Ethernet connection';
        states[Connection.WIFI]     = 'WiFi connection';
        states[Connection.CELL_2G]  = 'Cell 2G connection';
        states[Connection.CELL_3G]  = 'Cell 3G connection';
        states[Connection.CELL_4G]  = 'Cell 4G connection';
        states[Connection.NONE]     = 'No network connection';*/

        if((networkState == Connection.UNKNOWN) || (networkState == Connection.NONE))
		{
			//no connection
		}
		
		// do your thing!
		var docHeight = $(window).height();
		var headerHeight = $("#header").height();
		var footerHeight = $("#footer").height();
		var mapHeight = docHeight - headerHeight - footerHeight - 50;
		
		$("#map").height(mapHeight +"px");
		var maxResolution = 15543.0339;
		var maxExtent = new OpenLayers.Bounds(-20037508, -20037508, 20037508, 20037508);
		var restrictedExtent = maxExtent.clone();
		var touchNavOptions = {
				dragPanOptions: {
					interval: 0, //non-zero kills performance on some mobile phones
					enableKinetic: true
				}
		};
		
		
		var options = {
			div: "map",
			projection: WGS84,
			numZoomLevels : 20,
			maxResolution: maxResolution,
			maxExtent: maxExtent,
			restrictedExtent: restrictedExtent,
			controls: [
				new OpenLayers.Control.TouchNavigation(touchNavOptions),
				//new OpenLayers.Control.ZoomPanel()
			 ],
			layers: [new OpenLayers.Layer.OSM(), navigationLayer]
			//center: new OpenLayers.LonLat(-77.020000, 38.890000).transform(WGS84, WGS84_google_mercator),
			//zoom: 2
		};
		map = new OpenLayers.Map(options);
		
		navigator.geolocation.watchPosition(geolocationSuccess, geolocationError, 
		{
			enableHighAccuracy: true,
			maximumAge: 3000
		});
		
		var compassOptions = {
			frequency: 3000
		};
		
		navigator.compass.watchHeading(compassSuccess, compassError, compassOptions);
		
		var click = new OpenLayers.Control.Click();
		map.addControl(click);
		click.activate();
	}
    
    </script>
  </head>
  <body onload="onBodyLoad()">
	<div data-role="page"> 
          <div data-role="header" id="header"> 
               <h1> Header Content </h1>
          </div>
          <div data-role="content" id="content"> 
				<div id="map"></div>
          </div>
          <div data-role="footer" id="footer"> 
               <h1> Footer Content </h1>
          </div>
     </div>
  </body>
</html>
